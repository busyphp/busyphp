<extend name="@admin:page"/>
<block name="content">
    <literal>
    <?php
    /** @var array $traces */
    if (!function_exists('parse_padding')) {
        function parse_padding($source)
        {
            $length = strlen(strval(count($source['source']) + $source['first']));
            
            return 40 + ($length - 1) * 8;
        }
    }
    
    if (!function_exists('parse_class')) {
        function parse_class($name)
        {
            $names = explode('\\', $name);
            
            return '<abbr title="' . $name . '">' . end($names) . '</abbr>';
        }
    }
    
    if (!function_exists('parse_file')) {
        function parse_file($file, $line)
        {
            return '<a class="toggle" title="' . "{$file} line {$line}" . '">' . basename($file) . " line {$line}" . '</a>';
        }
    }
    
    if (!function_exists('parse_args')) {
        function parse_args($args)
        {
            $result = [];
            foreach ($args as $key => $item) {
                switch (true) {
                    case is_object($item):
                        $value = sprintf('<em>object</em>(%s)', parse_class(get_class($item)));
                    break;
                    case is_array($item):
                        if (count($item) > 3) {
                            $value = sprintf('[%s, ...]', parse_args(array_slice($item, 0, 3)));
                        } else {
                            $value = sprintf('[%s]', parse_args($item));
                        }
                    break;
                    case is_string($item):
                        if (strlen($item) > 20) {
                            $value = sprintf('\'<a class="toggle" title="%s">%s...</a>\'', htmlentities($item), htmlentities(substr($item, 0, 20)));
                        } else {
                            $value = sprintf("'%s'", htmlentities($item));
                        }
                    break;
                    case is_int($item):
                    case is_float($item):
                        $value = $item;
                    break;
                    case is_null($item):
                        $value = '<em>null</em>';
                    break;
                    case is_bool($item):
                        $value = '<em>' . ($item ? 'true' : 'false') . '</em>';
                    break;
                    case is_resource($item):
                        $value = '<em>resource</em>';
                    break;
                    default:
                        $value = htmlentities(str_replace("\n", '', var_export(strval($item), true)));
                    break;
                }
                
                $result[] = is_int($key) ? $value : "'{$key}' => {$value}";
            }
            
            return implode(', ', $result);
        }
    }
    if (!function_exists('echo_value')) {
        function echo_value($val)
        {
            if (is_array($val) || is_object($val)) {
                echo htmlentities(json_encode($val, JSON_PRETTY_PRINT));
            } elseif (is_bool($val)) {
                echo $val ? 'true' : 'false';
            } elseif (is_scalar($val)) {
                echo htmlentities($val);
            } else {
                echo 'Resource';
            }
        }
    }
    ?>
    </literal>
    <style>
        .exception-page {
            color:   #333;
            font:    16px Verdana, "Helvetica Neue", helvetica, Arial, 'Microsoft YaHei', sans-serif;
        }
        .exception-page h1 {
            margin:      10px 0 0;
            font-size:   28px;
            font-weight: 500;
            line-height: 32px;
        }
        .exception-page h2 {
            color:         #4288ce;
            font-weight:   400;
            padding:       6px 0;
            margin:        6px 0 0;
            font-size:     18px;
            border-bottom: 1px solid #eee;
        }
        .exception-page h3 {
            margin:      12px;
            font-size:   16px;
            font-weight: bold;
        }
        .exception-page abbr {
            cursor:                help;
            text-decoration:       underline;
            text-decoration-style: dotted;
        }
        .exception-page a {
            color:  #868686;
            cursor: pointer;
        }
        .exception-page a:hover {
            text-decoration: underline;
        }
        .exception-page .line-error {
            background: #f8cbcb;
        }
        .exception-page .echo table {
            width: 100%;
        }
        .exception-page .echo pre {
            padding:          16px;
            overflow:         auto;
            font-size:        85%;
            line-height:      1.45;
            background-color: #f7f7f7;
            border:           0;
            border-radius:    3px;
            font-family:      Consolas, "Liberation Mono", Menlo, Courier, monospace;
        }
        .exception-page .echo pre > pre {
            padding: 0;
            margin:  0;
        }
        /* Exception Info */
        .exception-page .exception {
            margin-top: 20px;
        }
        .exception-page .exception:first-child {
            margin-top: 0;
        }
        .exception-page .exception .message {
            padding:                 12px;
            border:                  1px solid #ddd;
            border-bottom:           0 none;
            line-height:             18px;
            font-size:               16px;
            border-top-left-radius:  4px;
            border-top-right-radius: 4px;
            font-family:             Consolas, "Liberation Mono", Courier, Verdana, "微软雅黑", serif;
        }
        .exception-page .exception .code {
            float:         left;
            text-align:    center;
            color:         #fff;
            margin-right:  12px;
            padding:       16px;
            border-radius: 4px;
            background:    #999;
        }
        .exception-page .exception .source-code {
            padding:    6px;
            border:     1px solid #ddd;

            background: #f9f9f9;
            overflow-x: auto;

        }
        .exception-page .exception .source-code pre {
            margin: 0;
        }
        .exception-page .exception .source-code pre ol {
            margin:       0;
            color:        #4288ce;
            display:      inline-block;
            min-width:    100%;
            box-sizing:   border-box;
            font-size:    14px;
            font-family:  "Century Gothic", Consolas, "Liberation Mono", Courier, Verdana, serif;
            padding-left: <?php echo (isset($source) && !empty($source)) ? parse_padding($source) : 40;  ?>px;
        }
        .exception-page .exception .source-code pre li {
            border-left: 1px solid #ddd;
            height:      18px;
            line-height: 18px;
        }
        .exception-page .exception .source-code pre code {
            color:       #333;
            height:      100%;
            display:     inline-block;
            border-left: 1px solid #fff;
            font-size:   14px;
            font-family: Consolas, "Liberation Mono", Courier, Verdana, "微软雅黑", serif;
        }
        .exception-page .exception .trace {
            padding:     6px;
            border:      1px solid #ddd;
            border-top:  0 none;
            line-height: 16px;
            font-size:   14px;
            font-family: Consolas, "Liberation Mono", Courier, Verdana, "微软雅黑", serif;
        }
        .exception-page .exception .trace h2:hover {
            text-decoration: underline;
            cursor:          pointer;
        }
        .exception-page .exception .trace ol {
            margin: 12px;
        }
        .exception-page .exception .trace ol li {
            padding: 2px 4px;
        }
        .exception-page .exception div:last-child {
            border-bottom-left-radius:  4px;
            border-bottom-right-radius: 4px;
        }

        /* Exception Variables */
        .exception-page .exception-var table {
            width:        100%;
            margin:       12px 0;
            box-sizing:   border-box;
            table-layout: fixed;
            word-wrap:    break-word;
        }
        .exception-page .exception-var table caption {
            text-align:  left;
            font-size:   16px;
            font-weight: bold;
            padding:     6px 0;
        }
        .exception-page .exception-var table caption small {
            font-weight: 300;
            display:     inline-block;
            margin-left: 10px;
            color:       #ccc;
        }
        .exception-page .exception-var table tbody {
            font-size:   13px;
            font-family: Consolas, "Liberation Mono", Courier, "微软雅黑", serif;
        }
        .exception-page .exception-var table td {
            padding:        0 6px;
            vertical-align: top;
            word-break:     break-all;
        }
        .exception-page .exception-var table td:first-child {
            width:       28%;
            font-weight: bold;
            white-space: nowrap;
        }
        .exception-page .exception-var table td pre {
            margin: 0;
        }

        /* Copyright Info */
        .exception-page .copyright {
            margin-top: 24px;
            padding:    12px 0;
            border-top: 1px solid #eee;
        }

        /* SPAN elements with the classes below are added by prettyprint. */
        .exception-page pre.prettyprint .pln { color: #000 }
        /* plain text */
        .exception-page pre.prettyprint .str { color: #080 }
        /* string content */
        .exception-page pre.prettyprint .kwd { color: #008 }
        /* a keyword */
        .exception-page pre.prettyprint .com { color: #800 }
        /* a comment */
        .exception-page pre.prettyprint .typ { color: #606 }
        /* a type name */
        .exception-page pre.prettyprint .lit { color: #066 }
        /* a literal value */
        /* punctuation, lisp open bracket, lisp close bracket */
        .exception-page pre.prettyprint .pun, .exception-page pre.prettyprint .opn, .exception-page pre.prettyprint .clo { color: #660 }
        .exception-page pre.prettyprint .tag { color: #008 }
        /* a markup tag name */
        .exception-page pre.prettyprint .atn { color: #606 }
        /* a markup attribute name */
        .exception-page pre.prettyprint .atv { color: #080 }
        /* a markup attribute value */
        .exception-page pre.prettyprint .dec, pre.prettyprint .var { color: #606 }
        /* a declaration; a variable name */
        .exception-page pre.prettyprint .fun { color: red }
        /* a function name */
    </style>

    <div class="exception-page">
        <?php
        if (\think\facade\App::isDebug()) { ?>
            <?php
            foreach ($traces as $index => $trace) { ?>
                <div class="exception">
                    <div class="message">
                        <div class="info">
                            <div>
                                <h2><?=("#{$index} [" . ($trace['code'] ?? 0) . "]") . sprintf('%s in %s', parse_class($trace['name'] ?? ''), parse_file($trace['file'] ?? '', $trace['line'] ?? 0));?></h2>
                            </div>
                            <div><h1><?=nl2br(htmlentities($trace['message'] ?? ''));?></h1></div>
                        </div>
                    </div>
                    <?php
                    if (!empty($trace['source'])) { ?>
                        <div class="source-code">
                        <pre class="prettyprint lang-php"><ol start="<?=$trace['source']['first'] ?? 0;?>"><?php
                                foreach ((array) $trace['source']['source'] as $key => $value) {
                                    ?><li class="line-<?=($index . '-' . ($key + ($trace['source']['first'] ?? 0)) . (($trace['line'] ?? 0) === $key + ($trace['source']['first'] ?? 0) ? ' line-error' : ''))?>"><code><?=htmlentities($value);?></code></li><?php
                                } ?></ol></pre>
                        </div>
                        <?php
                    } ?>
                    <div class="trace">
                        <h2 data-expand="<?=0 === $index ? '1' : '0';?>">Call Stack</h2>
                        <ol>
                            <li><?=sprintf('in %s', parse_file($trace['file'] ?? '', $trace['line'] ?? 0));?></li>
                            <?php
                            foreach ((array) $trace['trace'] as $value) { ?>
                                <li>
                                    <?php
                                    // Show Function
                                    if (($value['function'] ?? '')) {
                                        echo sprintf('at %s%s%s(%s)', isset($value['class']) ? parse_class($value['class']) : '', isset($value['type']) ? $value['type'] : '', $value['function'], isset($value['args']) ? parse_args($value['args'] ?? []) : '');
                                    }
                                    
                                    // Show line
                                    if (isset($value['file']) && isset($value['line'])) {
                                        echo sprintf(' in %s', parse_file($value['file'], $value['line']));
                                    }
                                    ?>
                                </li>
                                <?php
                            } ?>
                        </ol>
                    </div>
                </div>
                <?php
            } ?>
            <?php
        } else { ?>
            <div class="exception">
                <div class="info"><h1><?=htmlentities($message ?? '');?></h1></div>
            </div>
            <?php
        } ?>
        
        <?php
        if (!empty($datas)) { ?>
            <div class="exception-var">
                <h2>Exception Datas</h2>
                <?php
                foreach ((array) $datas as $label => $value) { ?>
                    <table>
                        <?php
                        if (empty($value)) { ?>
                            <caption><?php
                                echo $label; ?><small>empty</small></caption>
                            <?php
                        } else { ?>
                            <caption><?php
                                echo $label; ?></caption>
                            <tbody>
                                <?php
                                foreach ((array) $value as $key => $val) { ?>
                                    <tr>
                                        <td><?=htmlentities($key);?></td>
                                        <td><?
                                            echo_value($val); ?></td>
                                    </tr>
                                    <?php
                                } ?>
                            </tbody>
                            <?php
                        } ?>
                    </table>
                    <?php
                } ?>
            </div>
            <?php
        } ?>
        
        <?php
        if (!empty($tables)) { ?>
            <div class="exception-var">
                <h2>Environment Variables</h2>
                <?php
                foreach ((array) $tables as $label => $value) { ?>
                    <table>
                        <?php
                        if (empty($value)) { ?>
                            <caption><?=$label;?><small>empty</small></caption>
                            <?php
                        } else { ?>
                            <caption><?=$label;?></caption>
                            <tbody>
                                <?php
                                foreach ((array) $value as $key => $val) { ?>
                                    <tr>
                                        <td><?=htmlentities($key);?></td>
                                        <td><?
                                            echo_value($val); ?></td>
                                    </tr>
                                    <?php
                                } ?>
                            </tbody>
                            <?php
                        } ?>
                    </table>
                    <?php
                } ?>
            </div>
            <?php
        } ?>

        <div class="copyright">
            <a title="官方网站" href="//www.harter.cn" target="_blank">BusyPHP</a> V<?=\BusyPHP\App::init()->getFrameworkVersion();?>
            <span>Development From By <a href="//www.thinkphp.cn" target="_blank">ThinkPHP</a> V<?php echo \think\facade\App::version(); ?></span>
        </div>
    </div>
    
    <?php
    if (\think\facade\App::isDebug()) { ?>
        <script>

            ;(function () {
                var $root = $('.exception-page');

                // 短路径和长路径变换
                $root.find('.toggle').on('dblclick', function () {
                    var title = this.title;

                    this.title     = this.innerHTML;
                    this.innerHTML = title;
                });

                (function () {
                    var expand = function (dom, expand) {
                        var ol = $root.find('ol', dom.parentNode)[0];
                        expand = undefined === expand ? dom.attributes['data-expand'].value === '0' : undefined;
                        if (expand) {
                            dom.attributes['data-expand'].value = '1';
                            ol.style.display                    = 'none';
                            dom.innerText                       = 'Call Stack (展开)';
                        } else {
                            dom.attributes['data-expand'].value = '0';
                            ol.style.display                    = 'block';
                            dom.innerText                       = 'Call Stack (折叠)';
                        }
                    };
                    var traces = $('.trace');
                    for (var i = 0; i < traces.length; i++) {
                        var h2 = $('h2', traces[i])[0];
                        expand(h2);
                        h2.onclick = function () {
                            expand(this);
                        };
                    }
                })();

                require(['prettify/prettify.min'], function () {
                    prettyPrint();
                });
            })();
        </script>
        <?php
    } ?>
</block>
</html>