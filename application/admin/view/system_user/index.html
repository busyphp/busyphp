<extend name="@admin:layout"/>
<block name="head">
    <style type="text/scss">
        .__SCOPED__ {
            &table {
                td.--avatar {
                    position: relative;
                }

                .--avatar {
                    .img-thumbnail {
                        position: absolute;
                        width: 32px;
                        height: 32px;
                        left: 9px;
                        top: 5px;
                        background: #FFF;
                        object-fit: cover;
                    }
                }
            }
        }
    </style>
</block>
<block name="content">
    <div data-toggle="busy-table"
         data-state="__ROUTE__"
         data-search="@"
         data-show-columns="true"
         data-show-print="true"
         data-show-refresh="true"
         data-show-export-way="true"
         data-export-filename="{$system.page_title}-%s"
         data-toolbar="@"
         data-bordered="true"
         data-route="true"
         data-url="__URL__"
         data-height="true">

        <!--search-->
        <template data-template="search">
            <div data-toggle="busy-search-bar"
                 data-url="__URL__"
                 data-accurate-show="true"
                 data-fields="username:用户名,nickname:昵称,email:邮箱,phone:手机号,card_no:身份证号,name:姓名,tel:电话号码,qq:QQ号码,id:用户ID">
                <template data-template="left">
                    <div class="form-group">
                        <div class="input-group">
                            <div class="input-group-addon">状态</div>
                            <select class="form-control" name="status">
                                <?=\BusyPHP\helper\TransHelper::toOptionHtml($status)?>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <div class="input-group">
                            <div class="input-group-addon">性别</div>
                            <select class="form-control" name="sex">
                                <?=\BusyPHP\helper\TransHelper::toOptionHtml($sex)?>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <div class="input-group">
                            <div class="input-group-addon">角色</div>
                            <input data-toggle="busy-linkage-picker"
                                   name="group_id"
                                   placeholder="不限角色"
                                   data-url="{:url('system_group/data')}"
                                   data-strict="false"
                                   data-clear="true"/>
                        </div>
                    </div>
                </template>
            </div>
        </template>

        <!--toolbar-->
        <template data-template="toolbar">
            <div id="tableToolbar">
                <ba:access value="add">
                    <a class="btn btn-success"
                       data-toggle="busy-modal"
                       data-url="{:url('add')}"
                       data-size="lg"
                       data-ok="添加用户"
                       data-form-on-success="@table.reload|@modal.close">
                        <i class="fa fa-plus"></i>
                        添加
                    </a>
                </ba:access>

                <ba:access value="delete">
                    <a class="btn btn-danger"
                       data-url="{:url('delete')}"
                       data-confirm="确认要删除选中的%s个用户吗？"
                       data-checked="true"
                       data-disabled="true"
                       data-method="post"
                       data-on-success="@table.reload">
                        <i class="fa fa-trash"></i>
                        删除
                    </a>
                </ba:access>
            </div>
        </template>

        <!--table-->
        <table class="table table-bordered table-striped table-hover __SCOPED__table">
            <thead class="thead-light">
                <tr>
                    <th class="text-center"
                        data-checkbox="true"
                        data-print-ignore="true"
                        data-tableexport-display="false"
                        data-formatter="busyAdmin.data.checkboxState"></th>

                    <th class="text-center"
                        width="60"
                        data-field="id"
                        data-title="ID"
                        data-fixed="true"
                        data-sortable="true"
                        data-show-overflow="true"></th>

                    <th class="text-center --avatar"
                        width="50"
                        data-field="avatar"
                        data-formatter="@"
                        data-click-to-select="false"
                        data-title="头像">
                        <script type="text/html">
                            <img class="img-thumbnail padding-2" data-toggle="busy-image-viewer" src="{{value}}" data-avatar="true"/>
                        </script>
                    </th>

                    <th class="text-center"
                        data-min-width="300"
                        data-field="username"
                        data-title="账号"
                        data-halign="center"
                        data-align="left"
                        data-show-overflow="true"
                        data-sortable="true"
                        data-formatter="@">
                        <script type="text/html">
                            <a href="#" data-toggle="busy-modal" data-url="{:url('common.user/detail?id=')}{{item.id}}">{{value}}</a>

                            <ba-if value="item.system">
                                <kbd>系统管理员</kbd>
                            </ba-if>

                            <ba-if value="item.is_temp_lock">
                                <div class="text-danger size-12">已临时锁定至{{item.format_error_release}}后自动解锁
                                    <a class="badge badge-success" data-url="{:url('unlock?id=')}{{item.id}}" data-toggle="busy-request" data-confirm="确认要解锁该账户的临时锁定状态吗？" data-on-success="@table.reload">现在解锁</a>
                                </div>
                            </ba-if>
                        </script>
                    </th>
                    
                    <th class="text-center"
                        width="100"
                        data-field="nickname"
                        data-title="昵称"
                        data-show-overflow="true"
                        data-sortable="true"></th>

                    <th class="text-center"
                        width="120"
                        data-field="phone"
                        data-title="手机号"
                        data-show-overflow="true"
                        data-sortable="true"></th>

                    <th class="text-center"
                        width="160"
                        data-field="email"
                        data-title="邮箱"
                        data-show-overflow="true"
                        data-sortable="true"></th>

                    
                    <th class="text-center"
                        width="100"
                        data-field="name"
                        data-title="姓名"
                        data-visible="false"
                        data-show-overflow="true"
                        data-sortable="true"></th>

                    <th class="text-center"
                        width="170"
                        data-field="card_no"
                        data-title="身份证号"
                        data-visible="false"
                        data-show-overflow="true"
                        data-sortable="true"></th>

                    <th class="text-center"
                        width="75"
                        data-field="sex_name"
                        data-title="性别"
                        data-visible="false"
                        data-show-overflow="true"
                        data-sortable="true"></th>

                    <th class="text-center"
                        width="100"
                        data-field="birthday"
                        data-title="出生日期"
                        data-visible="false"
                        data-show-overflow="true"
                        data-sortable="true"></th>

                    <th class="text-center"
                        width="120"
                        data-field="tel"
                        data-title="电话"
                        data-visible="false"
                        data-show-overflow="true"
                        data-sortable="true"></th>

                    <th class="text-center"
                        width="120"
                        data-field="qq"
                        data-title="QQ号码"
                        data-visible="false"
                        data-show-overflow="true"
                        data-sortable="true"></th>

                    <th class="text-center"
                        width="120"
                        data-field="group_names"
                        data-formatter="@"
                        data-title="所属角色"
                        data-show-overflow="true">
                        <script type="text/html">
                            {{value.length ? value.join(', ') : '-'}}
                        </script>
                    </th>

                    <th class="text-center"
                        width="80"
                        data-field="checked"
                        data-title="状态"
                        data-show-overflow="true"
                        data-sortable="true"
                        data-formatter="@">
                        <script type="text/html">
                            <ba-if value="item.system || item.id == `{$system.user.id}`">
                                {{value ? '正常' : '禁用'}}
                                <ba-else/>
                                <input type="checkbox"
                                       class="switch input-xs primary"
                                       data-toggle="busy-checkbox"
                                       data-url="{:url('change_checked?id=')}{{item.id}}"
                                       title="正常,禁用" {{value ? 'checked' : ''}} />
                            </ba-if>
                        </script>
                    </th>

                    <th class="text-center"
                        width="160"
                        data-field="format_create_time"
                        data-title="创建时间"
                        data-align="center"
                        data-show-overflow="true"
                        data-sort-name="create_time"
                        data-sortable="true"></th>

                    <th class="text-center"
                        width="160"
                        data-field="format_last_time"
                        data-title="最后登录时间"
                        data-align="center"
                        data-visible="false"
                        data-show-overflow="true"
                        data-sort-name="last_time"
                        data-sortable="true"></th>
                    
                    <th class="text-center"
                        width="120"
                        data-field="login_ip"
                        data-title="最后登录IP"
                        data-align="center"
                        data-visible="false"
                        data-show-overflow="true"></th>
                    
                    <th class="text-center"
                        width="120"
                        data-field="last_ip"
                        data-title="上次登录IP"
                        data-align="center"
                        data-visible="false"
                        data-show-overflow="true"></th>
                    
                    <th class="text-center"
                        width="130"
                        data-field="login_total"
                        data-title="累计登录次数"
                        data-align="center"
                        data-visible="false"
                        data-sortable="true"
                        data-show-overflow="true"></th>

                    <th class="text-center"
                        width="70"
                        data-title="操作"
                        data-fixed-right="true"
                        data-print-ignore="true"
                        data-tableexport-display="false"
                        data-formatter="@">
                        <script type="text/html">
                            <ba:access value="edit">
                                <a class="btn btn-success btn-xs"
                                   href="{:url('edit?id=')}{{item.id}}"
                                   data-toggle="busy-modal"
                                   data-ok="修改用户"
                                   data-size="lg"
                                   data-form-on-success="@table.reload|@modal.close"><i class="fa fa-pencil"></i></a>
                            </ba:access>
                            <ba:access value="delete">
                                <ba-if value="!item.system && item.id != `{$system.user.id}`">
                                    <a class="btn btn-danger btn-xs"
                                       href="{:url('delete?id=')}{{item.id}}"
                                       data-toggle="busy-request"
                                       data-confirm="确认要删除该用户吗？"
                                       data-on-success="@table.reload"><i class="fa fa-trash"></i></a>
                                </ba-if>
                            </ba:access>
                        </script>
                    </th>
                </tr>
            </thead>
        </table>
    </div>
</block>
<block name="foot">
    <script>
        busyAdmin.data.checkboxState = function (value, item, index) {
            if (item.system || item.id == '{$system.user.id}') {
                return {disabled : true}
            }

            return value;
        };
    </script>
</block>